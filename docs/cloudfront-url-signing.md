# CloudFront URL Signing

This document describes the CloudFront URL signing implementation for the Sparks application.

## Overview

CloudFront URL signing is used to restrict access to images stored in S3 and served through CloudFront. This ensures that only authenticated users with valid signed URLs can access the images, providing an additional layer of security.

## Implementation Details

### Key Pair Generation

A public-private key pair is used for CloudFront URL signing. The private key is used to sign URLs, and the public key is used by CloudFront to verify the signatures.

The key pair is automatically generated by Terraform using the `tls_private_key` resource when the infrastructure is first deployed. The keys are generated only once and won't be regenerated on subsequent Terraform applies due to lifecycle rules.

### Key Storage

The keys are stored securely in AWS Systems Manager Parameter Store:

- Private key: `/{prefix}/cloudfront/private_key` (SecureString)
- Public key: `/{prefix}/cloudfront/public_key` (String)
- Key pair ID: `/{prefix}/cloudfront/key_pair_id` (String)

### CloudFront Configuration

The CloudFront distribution is configured to use a key group for URL signing. The key group contains the public key used to verify signatures.

The configuration is managed through Terraform in the `terraform/modules/cloudfront` directory.

### URL Signing in Express API

The Express API generates signed URLs for images using the `aws-cloudfront-sign` package. The implementation is in the `src/express-api/utils/cloudfront.js` file.

Key features:
- Retrieves the private key and key pair ID from SSM Parameter Store
- Implements caching to reduce SSM API calls
- Provides a simple `getSignedUrl` function for generating signed URLs
- Default URL expiration is set to 24 hours

### Usage in API Routes

The signed URLs are generated in the following API routes:

1. `GET /photos` - Returns a list of photos with signed URLs for images and thumbnails
2. `GET /photos/:id` - Returns a specific photo with signed URLs
3. `GET /photos/:id/persons` - Returns persons detected in a photo with signed URLs for person images

### UI Integration

The UI automatically uses the signed URLs returned by the API. No changes to the UI components are required as they already use the URLs provided by the API responses.

## Key Rotation

Since the keys are managed by Terraform with lifecycle rules to prevent automatic regeneration, key rotation requires manual intervention:

1. Remove or comment out the lifecycle blocks in the Terraform configuration for the following resources:
   - `tls_private_key.cloudfront_key`
   - `aws_ssm_parameter.cloudfront_private_key`
   - `aws_ssm_parameter.cloudfront_public_key`

2. Run `terraform apply` to generate new keys

3. After successful deployment, restore the lifecycle blocks to prevent future automatic regeneration

It's recommended to rotate keys periodically (e.g., every 90 days) as a security best practice.

## Troubleshooting

Common issues:

1. **Expired URLs**: Signed URLs have an expiration time (default: 24 hours). If a URL expires, the user will need to refresh the page to get new signed URLs.

2. **Invalid Signature**: This can happen if the private key in SSM doesn't match the public key registered with CloudFront. Verify that the keys are correctly synchronized.

3. **Missing Key Pair ID**: Ensure that the key pair ID is correctly stored in SSM and matches the ID of the public key in CloudFront.
